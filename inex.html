<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>lock password</title>
  <meta name="description" content="ØªØ·Ø¨ÙŠÙ‚ ÙˆÙŠØ¨ Ù„Ø­ÙØ¸ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙˆÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø­Ù„ÙŠØ§Ù‹ (lock password) - ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ´ÙÙŠØ± Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠ" />
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --muted:#666; --accent:#2563eb; --danger:#dc2626;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Naskh Arabic",sans-serif}
    body{margin:0;background:var(--bg);padding:20px;display:flex;justify-content:center}
    .app{width:100%;max-width:980px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    h1{margin:0;font-size:20px}
    .panel{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(15,23,42,0.06);margin-bottom:12px}
    label{display:block;margin-bottom:6px;font-size:13px;color:var(--muted)}
    input[type="text"], input[type="password"], textarea, select{width:100%;padding:10px;border:1px solid #e6e9ef;border-radius:8px;font-size:14px}
    .row{display:flex;gap:8px}
    .row.reverse{flex-direction:row-reverse}
    button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px solid #e6e9ef}
    button.warn{background:var(--danger)}
    .small{font-size:13px;padding:6px 10px}
    .list{display:grid;gap:8px;margin-top:10px}
    .item{display:flex;justify-content:space-between;align-items:start;padding:10px;border-radius:8px;border:1px solid #eef2ff;background:linear-gradient(180deg,#fff,#fbfdff)}
    .meta{max-width:66%}
    .meta .site{font-weight:700}
    .meta .user{font-size:13px;color:var(--muted);margin-top:4px}
    .meta .notes{font-size:12px;color:#444;margin-top:6px;white-space:pre-wrap}
    .actions{display:flex;gap:6px;flex-direction:column;align-items:flex-start}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, monospace;background:#f3f4f6;padding:6px;border-radius:6px;font-size:13px}
    .toolbar{display:flex;gap:8px;align-items:center}
    footer{font-size:12px;color:var(--muted);margin-top:8px}
    .hint{font-size:13px;color:#0f172a;background:#eef2ff;padding:8px;border-radius:8px}
    @media (max-width:700px){ .row{flex-direction:column} .meta{max-width:100%} .actions{flex-direction:row} }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>lock passowrd</h1>
        <div style="color:var(--muted);font-size:13px;margin-top:6px"> ÙŠÙ…ÙƒÙ†Ùƒ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ´ÙÙŠØ± Ø£Ùˆ ØªØ±ÙƒÙ‡</div>
      </div>
      <div class="toolbar">
          <input id="importFile" type="file" accept="text/plain" style="display:none" />
        </label>
      </div>
    </header>

    <!-- Master password / unlock -->
    <section class="panel" id="vaultPanel">
      <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap">
        <div style="flex:1;min-width:260px">
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø±ØºØ© Ù„ØªØ®Ø²ÙŠÙ† ØºÙŠØ± Ù…Ø´ÙØ±)</label>
          <input id="masterInput" type="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø±ØºØ©">
          <div style="margin-top:8px;display:flex;gap:8px">
            <button id="unlockBtn" class="small">ÙØªØ­ / ØªÙØ¹ÙŠÙ„</button>
            <button id="lockBtn" class="small ghost">Ù‚ÙÙ„</button>
            <button id="clearStorage" class="small ghost">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ù…Ø­Ù„ÙŠ</button>
          </div>
          <div style="margin-top:8px" class="hint">Ø¥Ø°Ø§ Ø£Ø¯Ø®Ù„Øª ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø±Ø¦ÙŠØ³ÙŠØ© Ø«Ù… ÙØªØ­Øª Ø§Ù„Ø®Ø²Ù†Ø©ØŒ Ø³ÙŠØªÙ… ØªØ´ÙÙŠØ± ÙˆØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´ÙÙ‘Ø±Ø©. Ø¥Ø°Ø§ ØªØ±ÙƒØªÙ‡Ø§ ÙØ§Ø±ØºØ© ÙØ³ÙŠØªÙ… Ø­ÙØ¸Ù‡Ø§ Ø¨Ø¯ÙˆÙ† ØªØ´ÙÙŠØ±.</div>
        </div>
        <div style="min-width:240px">
          <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø²Ù†Ø©</label>
          <div id="status" class="mono">Ù…Ù‚ÙÙ„</div>
        </div>
      </div>
    </section>

    <!-- Add / edit form -->
    <section class="panel" id="formPanel" style="display:none">
      <form id="entryForm">
        <div class="row reverse">
          <div style="flex:1">
            <label>Ø§Ù„Ù…ÙˆÙ‚Ø¹ / Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</label>
            <input id="site" type="text" placeholder="Ù…Ø«Ø§Ù„: Gmail Ø£Ùˆ Ø¨Ù†Ùƒ Ø§Ù„...">
          </div>
          <div style="width:240px">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… / Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
            <input id="username" type="text" placeholder="example@email.com">
          </div>
        </div>

        <div class="row" style="margin-top:8px;align-items:center">
          <div style="flex:1">
            <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <input id="password" type="text" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
          </div>
          <div style="width:190px;display:flex;gap:8px">
            <button type="button" id="genBtn" class="ghost">ØªÙˆÙ„ÙŠØ¯</button>
            <button type="button" id="copyPwd" class="ghost">Ù†Ø³Ø®</button>
            <button type="submit" id="saveBtn">Ø¥Ø¶Ø§ÙØ©</button>
          </div>
        </div>

        <div style="margin-top:8px">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
          <textarea id="notes" rows="3" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©"></textarea>
        </div>
      </form>
    </section>

    <!-- Entries list -->
    <section class="panel" id="listPanel" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <div style="font-weight:700">Ù…Ø¯Ø®Ù„Ø§ØªÙƒ</div>
        <div style="display:flex;gap:8px;align-items:center">
          <label style="font-size:13px;color:var(--muted)">Ø¹Ø±Ø¶:</label>
          <select id="filterSelect" style="padding:6px;border-radius:6px">
            <option value="all">Ø§Ù„ÙƒÙ„</option>
            <option value="recent">Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹</option>
          </select>
        </div>
      </div>

      <div id="entries" class="list"></div>
      <div id="emptyHint" style="display:none;color:var(--muted);margin-top:10px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯Ø®Ù„Ø§Øª Ø¨Ø¹Ø¯.</div>
    </section>

    <footer>
      <div class="panel" style="background:transparent;padding:6px 0">
        <div style="color:var(--muted)">ØªÙ†Ø¨ÙŠÙ‡ Ø£Ù…Ù†ÙŠ: Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù…Ù„ Ù…Ø­Ù„ÙŠÙ‹Ø§. Ù„Ø§ ØªÙØ¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø§Ø³Ø© ÙÙŠ Ù…ØªØµÙØ­ Ø´Ø®ØµÙŠ ØºÙŠØ± Ø¢Ù…Ù†. Ø¥Ø°Ø§ Ø§Ø®ØªØ±Øª Ø§Ù„ØªØ´ÙÙŠØ±: Ù„Ø§ ØªÙ†Ø³ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.</div>
      </div>
    </footer>
  </div>

<script>
/* ======= Storage / Crypto ======= */
const STORAGE_KEY = 'simple_vault_v2';
const SALT_KEY = 'simple_vault_salt_v2';

const encoder = new TextEncoder();
const decoder = new TextDecoder();

// Convert base64 helpers
function b64enc(buf){ return btoa(String.fromCharCode(...new Uint8Array(buf))); }
function b64dec(str){ return Uint8Array.from(atob(str), c=>c.charCodeAt(0)); }

async function deriveKey(password, salt){
  const base = await crypto.subtle.importKey('raw', encoder.encode(password), {name:'PBKDF2'}, false, ['deriveKey']);
  return crypto.subtle.deriveKey({
    name:'PBKDF2',
    salt,
    iterations:200000,
    hash:'SHA-256'
  }, base, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']);
}

function randomBytes(n){ const a=new Uint8Array(n); crypto.getRandomValues(a); return a; }

async function encryptWithKey(key, obj){
  const iv = randomBytes(12);
  const pt = encoder.encode(JSON.stringify(obj));
  const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, pt);
  return b64enc(iv) + '.' + b64enc(ct);
}

async function decryptWithKey(key, blob){
  const parts = blob.split('.');
  if(parts.length !== 2) throw new Error('invalid blob');
  const iv = b64dec(parts[0]), ct = b64dec(parts[1]);
  const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
  return JSON.parse(decoder.decode(pt));
}

// Fallback: plain JSON storage
function savePlain(entries){ localStorage.setItem(STORAGE_KEY, JSON.stringify(entries)); }
function loadPlain(){ const t = localStorage.getItem(STORAGE_KEY); return t ? JSON.parse(t) : []; }

/* ======= App state ======= */
let keyObj = null; // {key, salt (Uint8Array) } when unlocked with master password, else null (plaintext mode)
let entries = [];
let editingIndex = -1;

/* ======= UI refs ======= */
const masterInput = document.getElementById('masterInput');
const unlockBtn = document.getElementById('unlockBtn');
const lockBtn = document.getElementById('lockBtn');
const statusDiv = document.getElementById('status');
const formPanel = document.getElementById('formPanel');
const listPanel = document.getElementById('listPanel');
const entriesDiv = document.getElementById('entries');
const emptyHint = document.getElementById('emptyHint');
const entryForm = document.getElementById('entryForm');
const siteInput = document.getElementById('site');
const userInput = document.getElementById('username');
const pwdInput = document.getElementById('password');
const notesInput = document.getElementById('notes');
const genBtn = document.getElementById('genBtn');
const copyPwdBtn = document.getElementById('copyPwd');
const saveBtn = document.getElementById('saveBtn');
const clearStorageBtn = document.getElementById('clearStorage');
const exportBtn = document.getElementById('exportBtn');
const importFile = document.getElementById('importFile');
const filterSelect = document.getElementById('filterSelect');

/* ======= Initialize ======= */
function updateStatus(){
  if(keyObj) statusDiv.textContent = 'Ù…ÙØ¹Ù„ (Ù…Ø´ÙÙ‘ÙØ±)';
  else statusDiv.textContent = 'Ù…Ù‚ÙÙ„ / Ø¨Ø¯ÙˆÙ† ØªØ´ÙÙŠØ±';
}
function showPanels(show){
  formPanel.style.display = show ? 'block' : 'none';
  listPanel.style.display = show ? 'block' : 'none';
}
function renderEntries(){
  entriesDiv.innerHTML = '';
  if(!entries || entries.length === 0){
    emptyHint.style.display = 'block';
    return;
  } else emptyHint.style.display = 'none';
  let list = [...entries];
  if(filterSelect.value === 'recent') list.sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt));
  list.forEach((it, idx) => {
    const div = document.createElement('div'); div.className='item';
    const meta = document.createElement('div'); meta.className='meta';
    const site = document.createElement('div'); site.className='site'; site.textContent = it.site || '(Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†)';
    const user = document.createElement('div'); user.className='user'; user.textContent = it.username || '';
    const notes = document.createElement('div'); notes.className='notes'; notes.textContent = it.notes || '';
    meta.appendChild(site); if(it.username) meta.appendChild(user); if(it.notes) meta.appendChild(notes);
    const actions = document.createElement('div'); actions.className='actions';
    const pwd = document.createElement('div'); pwd.className='mono'; pwd.textContent = it.password ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : '';
    const btnView = document.createElement('button'); btnView.className='ghost small'; btnView.textContent='Ø¹Ø±Ø¶';
    btnView.onclick = ()=>{ alert(`Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${it.site}\\nØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${it.username}\\nÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: ${it.password || ''}\\n\\nÙ…Ù„Ø§Ø­Ø¸Ø§Øª:\\n${it.notes || ''}`) };
    const btnCopy = document.createElement('button'); btnCopy.className='ghost small'; btnCopy.textContent='Ù†Ø³Ø®';
    btnCopy.onclick = ()=>{ navigator.clipboard.writeText(it.password || '').then(()=>alert('ØªÙ… Ø§Ù„Ù†Ø³Ø®')) };
    const btnEdit = document.createElement('button'); btnEdit.className='ghost small'; btnEdit.textContent='ØªØ¹Ø¯ÙŠÙ„';
    btnEdit.onclick = ()=>{ editingIndex = idx; siteInput.value=it.site||''; userInput.value=it.username||''; pwdInput.value=it.password||''; notesInput.value=it.notes||''; saveBtn.textContent='Ø­ÙØ¸' };
    const btnDel = document.createElement('button'); btnDel.className='warn small'; btnDel.textContent='Ø­Ø°Ù';
    btnDel.onclick = ()=>{ if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¯Ø®Ù„Ø©ØŸ')) { entries.splice(idx,1); persistEntries(); renderEntries(); } };
    actions.appendChild(pwd); actions.appendChild(btnView); actions.appendChild(btnCopy); actions.appendChild(btnEdit); actions.appendChild(btnDel);
    div.appendChild(meta); div.appendChild(actions);
    entriesDiv.appendChild(div);
  });
}

/* ======= Persistence ======= */
async function persistEntries(){
  if(keyObj && keyObj.key){
    // encrypt and save
    try{
      const blob = await encryptWithKey(keyObj.key, entries);
      localStorage.setItem(STORAGE_KEY, blob);
    }catch(e){ console.error('encrypt save failed',e); alert('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´ÙÙ‘Ø±Ø©') }
  }else{
    // save plain
    savePlain(entries);
  }
}

async function loadEntriesFromStorage(){
  // determine if there's an encrypted blob
  const blob = localStorage.getItem(STORAGE_KEY);
  if(!blob) { entries = []; return; }
  if(keyObj && keyObj.key){
    // try decrypt
    try{
      const dec = await decryptWithKey(keyObj.key, blob);
      entries = Array.isArray(dec) ? dec : [];
      return;
    }catch(e){
      console.warn('failed decrypt with provided key', e);
      // fallback: maybe stored plain
    }
  }
  try{
    // attempt parse as plain
    entries = JSON.parse(blob);
  }catch(e){
    // unknown format
    entries = [];
  }
}

/* ======= UI actions ======= */
unlockBtn.addEventListener('click', async ()=>{
  const pass = masterInput.value || '';
  if(pass){
    // ensure salt exists or create
    let saltB64 = localStorage.getItem(SALT_KEY);
    let salt;
    if(!saltB64){
      salt = randomBytes(16);
      localStorage.setItem(SALT_KEY, b64enc(salt));
    }else salt = b64dec(saltB64);
    try{
      const k = await deriveKey(pass, salt);
      keyObj = { key: k, salt };
      await loadEntriesFromStorage();
      showPanels(true);
      updateStatus();
      renderEntries();
      alert('Ø§Ù„Ø®Ø²Ù†Ø© Ù…ÙØªÙˆØ­Ø© ÙˆÙ…Ø´ÙØ±Ø© (ØªØ°ÙƒØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)');
    }catch(e){
      console.error(e);
      alert('ÙØ´Ù„ ÙØªØ­ Ø§Ù„Ø®Ø²Ù†Ø© Ø¨Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù…Ø¯Ø®Ù„');
    }
  }else{
    // plaintext mode
    keyObj = null;
    entries = loadPlain();
    showPanels(true);
    updateStatus();
    renderEntries();
    alert('Ø®Ø²Ù†Ø© Ø¨Ø¯ÙˆÙ† ØªØ´ÙÙŠØ± (Ø³ÙŠØªÙ… ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¨Ø¯ÙˆÙ† ØªØ´ÙÙŠØ±)');
  }
});

lockBtn.addEventListener('click', ()=>{
  keyObj = null;
  masterInput.value = '';
  entries = [];
  editingIndex = -1;
  showPanels(false);
  updateStatus();
  entriesDiv.innerHTML = '';
  emptyHint.style.display='none';
});

entryForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const it = {
    site: siteInput.value.trim(),
    username: userInput.value.trim(),
    password: pwdInput.value,
    notes: notesInput.value,
    createdAt: new Date().toISOString()
  };
  if(editingIndex >= 0){
    entries[editingIndex] = it;
    editingIndex = -1;
    saveBtn.textContent = 'Ø¥Ø¶Ø§ÙØ©';
  }else entries.unshift(it);
  await persistEntries();
  renderEntries();
  entryForm.reset();
});

genBtn.addEventListener('click', ()=>{
  const len = 16;
  const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()-_=+[]{}<>?';
  let out = '';
  const arr = new Uint32Array(len); crypto.getRandomValues(arr);
  for(let i=0;i<len;i++) out += chars[arr[i] % chars.length];
  pwdInput.value = out;
});

copyPwdBtn.addEventListener('click', ()=>{ navigator.clipboard.writeText(pwdInput.value || '').then(()=>alert('ØªÙ… Ø§Ù„Ù†Ø³Ø®')) });

clearStorageBtn.addEventListener('click', ()=>{ if(confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© (Ù„Ù† ØªØ¤Ø«Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ù†Ø³Ø®Ø© Ù…ØµØ¯Ø±Ø©). Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')){ localStorage.removeItem(STORAGE_KEY); localStorage.removeItem(SALT_KEY); entries=[]; renderEntries(); alert('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø· Ø§Ù„Ù…Ø­Ù„ÙŠ') } });



importFile.addEventListener('change', (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const r = new FileReader();
  r.onload = ()=>{ localStorage.setItem(STORAGE_KEY, r.result); alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù. Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø´ÙØ±Ù‹Ø§ØŒ Ø§ÙØªØ­ Ø§Ù„Ø®Ø²Ù†Ø© Ø¨ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù†ÙØ³Ù‡Ø§.'); };
  r.readAsText(f);
});

/* ======= On load: show locked state ======= */
updateStatus();
showPanels(false);

/* ======= Filter change ======= */
filterSelect.addEventListener('change', ()=> renderEntries());

// Create manifest blob and add link
const manifest = {
  name: "Ø®Ø²Ù†Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª",
  short_name: "Ø®Ø²Ù†Ø©",
  start_url: ".",
  display: "standalone",
  background_color: "#f6f7fb",
  theme_color: "#2563eb",
  icons: [
    {
  src: "data:image/svg+xml;base64," +
    btoa(unescape(encodeURIComponent(
      `<svg xmlns='http://www.w3.org/2000/svg' width='192' height='192'>
        <rect fill='#2563eb' width='100%' height='100%'/>
        <text x='50%' y='56%' text-anchor='middle' font-size='90' fill='#fff' font-family='Arial'>ğŸ”</text>
      </svg>`
    ))),
  sizes: "192x192",
  type: "image/svg+xml"
}
]
};
const manBlob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
const manURL = URL.createObjectURL(manBlob);
const link = document.createElement('link'); link.rel='manifest'; link.href = manURL;
document.head.appendChild(link);

// service worker: simple caching for app shell (created dynamically)
if('serviceWorker' in navigator){
  const swCode = `
    const CACHE = 'vault-cache-v1';
    const urls = ['.'];
    self.addEventListener('install', e=>{ e.waitUntil(caches.open(CACHE).then(c=>c.addAll(urls)).then(()=>self.skipWaiting()));});
    self.addEventListener('activate', e=>{ e.waitUntil(self.clients.claim()); });
    self.addEventListener('fetch', e=>{ e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)));});
  `;
  const blob = new Blob([swCode], {type:'application/javascript'});
  const swURL = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swURL).then(()=>console.log('sw registered')).catch(e=>console.warn('sw failed',e));
}

/* ======= On page unload: try to persist (if unlocked) ======= */
window.addEventListener('beforeunload', ()=> { persistEntries(); });

</script>
</body>
</html>
